/*! SuggestionStore https://github.com/StudioSol/SuggestionStore.git 05-02-2014 */
!function(a){function b(a){return a.type+":"+a.id}function c(a,b){for(var c,d,e={},f=0;f<a.length;f+=1)c=a[f],d=b(c),d in e?e[d].push(c):e[d]=[c];return e}a.getDocumentKey=b,a.groupBy=c}(window.SuggestionStore=window.SuggestionStore||{}),function(a){function b(){this.counter=1,this.callback=null}function c(a){this.idb=a}function d(a,b){this.name=a,this.version=b}function e(a,b){a.get(function(a,d){a?b(a,null):b(null,new c(d))})}var f=window.indexedDB||window.mozIndexedDB||window.webkitIndexedDB||window.msIndexedDB,g=window.IDBKeyRange||window.webkitIDBKeyRange||window.msIDBKeyRange;a.Lock=b,b.prototype.check=function(){this.callback&&0===this.counter&&(this.callback(),this.callback=null)},b.prototype.setCallback=function(a){this.callback=a,this.check()},b.prototype.incr=function(){this.counter+=1},b.prototype.decr=function(){this.counter>0&&(this.counter-=1),this.check()},c.prototype.createDocTokens=function(a,c,d){function e(a){i.push(a.target.result),f.decr()}var f,g,h,i=[],j=SuggestionStore.tokenize(c.text);for(f=new b,g=a.objectStore("references"),h=0;h<j.length;h+=1)f.incr(),g.add({token:j[h],documentKey:c._key}).onsuccess=e;f.setCallback(function(){d(i)}),f.decr()},c.prototype.removeDocTokens=function(a,b,c){var d,e,f;for(d=function(){b.decr()},e=a.objectStore("references"),f=0;f<c.length;f+=1)b.incr(),e["delete"](c[f]).onsuccess=d},c.prototype.insertDocument=function(a,c){var d,e,f;d=SuggestionStore.getDocumentKey(a),a._key=d,e=this.idb.transaction(["documents","references"],"readwrite"),f=new b,f.incr(),this.createDocTokens(e,a,function(b){a._tokenRefs=b,f.incr(),e.objectStore("documents").add(a).onsuccess=function(){f.decr()},f.decr()}),f.setCallback(function(){c(null)}),f.decr()},c.prototype.updateDocument=function(a,c,d,e){var f,g,h,i,j,k=this;f=this.idb.transaction(["documents","references"],"readwrite"),h=new b,g=SuggestionStore.getDocumentKey({type:a,id:c}),i=f.objectStore("documents"),j=function(a){h.incr(),i.put(a).onsuccess=function(){h.decr()}},h.incr(),i.get(g).onsuccess=function(a){var b,c;b=a.target.result,c=d(b),c._key=g,b&&b===c.text?j(c):(b&&k.removeDocTokens(f,h,b._tokenRefs.slice()),c._tokenRefs=[],h.incr(),k.createDocTokens(f,c,function(a){c._tokenRefs=a,j(c),h.decr()})),h.decr()},h.setCallback(function(){e(null)}),h.decr()},c.prototype.deleteDocument=function(a,c){var d,e,f,g=this;d=this.idb.transaction(["documents","references"],"readwrite"),e=new b,f=d.objectStore("documents"),e.incr(),f.get(a).onsuccess=function(b){var c=b.target.result;g.removeDocTokens(d,e,c._tokenRefs.slice()),e.incr(),f["delete"](a).onsuccess=function(){e.decr()},e.decr()},e.setCallback(function(){c(null)}),e.decr()},c.prototype.getDocument=function(a,b,c){var d,e;d=SuggestionStore.getDocumentKey({type:a,id:b}),e=this.idb.transaction(["documents"]).objectStore("documents").get(d),e.onsuccess=function(a){var b=a.target.result;b&&(delete b._key,delete b._tokenRefs),c(null,b)},e.onerror=function(a){c(a.target.errorCode,null)}},c.prototype.getDocs=function(a,c){var d,e,f,g,h=[];for(d=new b,f=this.idb.transaction(["documents"]).objectStore("documents"),e=function(a){var b=a.target.result;b&&(delete b._key,delete b._tokenRefs,h.push(b)),d.decr()},g=0;g<a.length;g+=1)d.incr(),f.get(a[g]).onsuccess=e;d.setCallback(function(){c(h)}),d.decr()},c.prototype.search=function(a,b){function c(a){return function(b){var c=b.target.result;c?(j[a].push(c.value.documentKey),c["continue"]()):f.decr()}}var d,e,f,h,i=this,j={};for(d=SuggestionStore.cleanQuery(a),f=new SuggestionStore.Lock,h=this.idb.transaction(["references"]).objectStore("references").index("token"),e=0;e<d.length;e+=1)j[token]=[];for(e=0;e<d.length;e+=1)f.incr(),h.openCursor(g.only(d[e])).onsuccess=c(d[e]);f.setCallback(function(){var a=SuggestionStore.getObjectValues(j),c=SuggestionStore.getDocumentSet,d=SuggestionStore.map(a,c),e=SuggestionStore.getIntersection(d);i.getDocs(e,function(a){b(null,a)})}),f.decr()},a.DatabaseManager=d,d.prototype.get=function(a){var b=this,c=f.open(this.name,this.version);c.onsuccess=function(){a(null,this.result)},c.onerror=function(b){a(b.target.errorCode,null)},c.onupgradeneeded=function(a){b.handleUpgradeNeeded(a)}},d.prototype.initialSetup=function(a){var b;a.createObjectStore("documents",{keyPath:"_key"}),b=a.createObjectStore("references",{autoIncrement:!0}),b.createIndex("token","token")},d.prototype.handleUpgradeNeeded=function(a){this.initialSetup(a.currentTarget.result)},a.getStorage=e}(window.SuggestionStore=window.SuggestionStore||{}),function(a){function b(){}function c(){this.REs={}}function d(){}function e(){}function f(a,b,c){var d=[];b=b||1,c=Math.min(a.length,c||Number.MAX_VALUE);do a=a.slice(0,c),d.push(a);while(--c>=b);return d.reverse()}function g(a){for(var b=[],c=f(a.join(" "),1,30),d=0,e=c.length;e>d;d+=1)b.push(c[d]);return b}function h(a){for(var b=[],c=0,d=a.length;d>c;c+=1)b.push.apply(b,f(a[c],1,20));return b}function i(a){for(var b,c={},d=0,e=a.length,f=[];e>d;d+=1)b=a[d],b in c||(c[b]=1,f.push(b));return f}function j(a){this.steps=a}function k(a){return n.apply(a)}function l(a){var b;return a=n.apply(a),b=a.slice(),b.push.apply(b,g(a)),b.push.apply(b,h(a)),i(b)}b.prototype.wsRE=/\s/,b.prototype.replaceRE=/^\s\s*/,b.prototype.apply=function(a){for(var b=a.replace(this.replaceRE,""),c=this.wsRE,d=b.length;c.test(b.charAt(--d)););return b.slice(0,d+1)},a.Replace=c,c.prototype.setMap=function(a){var b,c,d={};this.REs={};for(b in a)a.hasOwnProperty(b)&&(c=a[b],c in d?d[c].push(b):d[c]=[b]);for(b in d)d.hasOwnProperty(b)&&(c=d[b],this.REs[b]=new RegExp("("+c.join("|")+")","gi"))},c.prototype.apply=function(a){var b,c,d;b=a;for(c in this.REs)this.REs.hasOwnProperty(c)&&(d=this.REs[c],b=b.replace(d,c));return b};var m=new c;m.setMap({á:"a",à:"a",â:"a",ã:"a",ä:"a",é:"e",è:"e",ê:"e",ë:"e",í:"i",ì:"i",î:"i",ó:"o",ò:"o",ô:"o",õ:"o",ö:"o",ú:"u",ù:"u",û:"u",ü:"u",ç:"c",ñ:"n"}),a.unicodeReplace=m,a.Split=d,d.prototype.RE=/[^\w\d]+/g,d.prototype.apply=function(a){var b,c=0,d=[];for(a=a.split(this.RE),c=0;c<a.length;c+=1)b=a[c],b.length&&d.push(b);return d},a.Lower=e,e.prototype.apply=function(a){return(""+a).toLowerCase()},a.createNgrams=f,a.addPhraseNgrams=g,a.addTokenNgrams=h,a.getTokenSet=i,a.Pipeline=j,j.prototype.apply=function(a){var b,c,d=0,e=a;for(b=this.steps.length;b>d;d+=1)c=this.steps[d],e=c.apply(e);return e};var n=new j([new b,new e,m,new d]);a.cleanQuery=k,a.tokenize=l}(window.SuggestionStore=window.SuggestionStore||{}),function(a){function b(a){var b,c,d=[];for(b in a)a.hasOwnProperty(b)&&(c=a[b],d.push(c));return d}function c(a){for(var b,c={},d=0,e=[];d<a.length;d+=1)b=a[d],b in c?c[b]+=1:(c[b]=1,e.push(b));return e.sort(function(a,b){return c[a]>c[b]?-1:1}),e}function d(a){for(var b,c,d=a.length,e={},f=0,g=0,h=[];d>f;f+=1)for(b=a[f],g=0;g<b.length;g+=1)c=b[g],e[c]?e[c]+=1:e[c]=1;for(c in e)e[c]===d&&h.push(c);return h}a.map=function(a,b){for(var c=a.length,d=0,e=[];c>d;d+=1)e.push(b(a[d]));return e},a.getObjectValues=b,a.getDocumentSet=c,a.getIntersection=d}(window.SuggestionStore=window.SuggestionStore||{});