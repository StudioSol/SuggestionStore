!function(a){function b(a){return a.type+":"+a.id}function c(a){for(var b,c={},d=0,e=[];d<a.length;d+=1)b=a[d],b in c?c[b]+=1:(c[b]=1,e.push(b));return e.sort(function(a,b){return c[a]>c[b]?-1:1}),e}a.getDocumentKey=b,a.getDocumentSet=c}(window.SuggestionStore=window.SuggestionStore||{}),function(a){function b(){this.counter=1,this.callback=null}function c(a){this.idb=a}function d(a,b,d){var f=e.open(a,b);f.onsuccess=function(){d(null,new c(this.result))},f.onerror=function(a){d(a.target.errorCode,null)},f.onupgradeneeded=function(a){var b,c=a.currentTarget.result;c.createObjectStore("documents",{keyPath:"_key"}),b=c.createObjectStore("references",{autoIncrement:!0}),b.createIndex("token","token")}}var e=window.indexedDB||window.mozIndexedDB||window.webkitIndexedDB||window.msIndexedDB,f=window.IDBKeyRange||window.webkitIDBKeyRange||window.msIDBKeyRange;a.Lock=b,b.prototype.check=function(){this.callback&&0===this.counter&&(this.callback(),this.callback=null)},b.prototype.setCallback=function(a){this.callback=a,this.check()},b.prototype.incr=function(){this.counter+=1},b.prototype.decr=function(){this.counter>0&&(this.counter-=1),this.check()},c.prototype.createDocTokens=function(a,c,d){var e,f,g,h=[],i=SuggestionStore.tokenize(c.text);for(e=new b,onRefAdded=function(a){h.push(a.target.result),e.decr()},f=a.objectStore("references"),g=0;g<i.length;g+=1)e.incr(),f.add({token:i[g],documentKey:c._key}).onsuccess=onRefAdded;e.setCallback(function(){d(h)}),e.decr()},c.prototype.removeDocTokens=function(a,b,c){var d,e,f;for(d=function(){b.decr()},e=a.objectStore("references"),f=0;f<c.length;f+=1)b.incr(),e["delete"](c[f]).onsuccess=d},c.prototype.insertDocument=function(a,c){var d,e,f;d=SuggestionStore.getDocumentKey(a),a._key=d,e=this.idb.transaction(["documents","references"],"readwrite"),f=new b,f.incr(),this.createDocTokens(e,a,function(b){a._tokenRefs=b,f.incr(),e.objectStore("documents").add(a).onsuccess=function(){f.decr()},f.decr()}),f.setCallback(function(){c(null)}),f.decr()},c.prototype.updateDocument=function(a,c){var d,e,f,g,h,i=this;d=this.idb.transaction(["documents","references"],"readwrite"),f=new b,e=SuggestionStore.getDocumentKey(a),a._key=e,g=d.objectStore("documents"),h=function(){f.incr(),g.put(a).onsuccess=function(){f.decr()}},f.incr(),g.get(e).onsuccess=function(b){var c=b.target.result;c&&c===a.text?h():(c&&i.removeDocTokens(d,f,c._tokenRefs.slice()),a._tokenRefs=[],f.incr(),i.createDocTokens(d,a,function(b){a._tokenRefs=b,h(),f.decr()})),f.decr()},f.setCallback(function(){c(null)}),f.decr()},c.prototype.deleteDocument=function(a,c){var d,e,f,g=this;d=this.idb.transaction(["documents","references"],"readwrite"),e=new b,f=d.objectStore("documents"),e.incr(),f.get(a).onsuccess=function(b){var c=b.target.result;g.removeDocTokens(d,e,c._tokenRefs.slice()),e.incr(),f["delete"](a).onsuccess=function(){e.decr()},e.decr()},e.setCallback(function(){c(null)}),e.decr()},c.prototype.getDocs=function(a,c){var d,e,f,g,h=[];for(d=new b,f=this.idb.transaction(["documents"]).objectStore("documents"),e=function(a){var b=a.target.result;delete b._key,delete b._tokenRefs,h.push(b),d.decr()},g=0;g<a.length;g+=1)d.incr(),f.get(a[g]).onsuccess=e;d.setCallback(function(){c(h)}),d.decr()},c.prototype.search=function(a,b){var c,d,e,g,h,i=this,j=[];for(c=SuggestionStore.tokenize(a),e=new SuggestionStore.Lock,g=this.idb.transaction(["references"]).objectStore("references").index("token"),h=function(a){var b=a.target.result;b?(j.push(b.value.documentKey),b["continue"]()):e.decr()},d=0;d<c.length;d+=1)e.incr(),g.openCursor(f.only(c[d])).onsuccess=h;e.setCallback(function(){i.getDocs(SuggestionStore.getDocumentSet(j),function(a){b(null,a)})}),e.decr()},a.getStorage=d}(window.SuggestionStore=window.SuggestionStore||{}),function(a){function b(){this.REs={}}function c(){}function d(){}function e(a,b,c){var d=[];b=b||1,c=Math.min(a.length,c||Number.MAX_VALUE);do a=a.slice(0,c),d.push(a);while(--c>=b);return d.reverse()}function f(a){for(var b=[],c=e(a.join(" "),1,30),d=0,f=c.length;f>d;d+=1)b.push(c[d]);return b}function g(a){for(var b=[],c=0,d=a.length;d>c;c+=1)b.push.apply(b,e(a[c],1,20));return b}function h(a){for(var b,c={},d=0,e=a.length,f=[];e>d;d+=1)b=a[d],b in c||(c[b]=1,f.push(b));return f}function i(a){this.steps=a}function j(a){var b;return a=l.apply(a),b=a.slice(),b.push.apply(b,f(a)),b.push.apply(b,g(a)),h(b)}a.Replace=b,b.prototype.setMap=function(a){var b,c,d={};this.REs={};for(b in a)a.hasOwnProperty(b)&&(c=a[b],c in d?d[c].push(b):d[c]=[b]);for(b in d)d.hasOwnProperty(b)&&(c=d[b],this.REs[b]=new RegExp("("+c.join("|")+")","gi"))},b.prototype.apply=function(a){var b,c,d;b=a;for(c in this.REs)this.REs.hasOwnProperty(c)&&(d=this.REs[c],b=b.replace(d,c));return b};var k=new b;k.setMap({"á":"a","à":"a","â":"a","ã":"a","ä":"a","é":"e","è":"e","ê":"e","ë":"e","í":"i","ì":"i","î":"i","ó":"o","ò":"o","ô":"o","õ":"o","ö":"o","ú":"u","ù":"u","û":"u","ü":"u","ç":"c","ñ":"n"}),a.unicodeReplace=k,a.Split=c,c.prototype.RE=/[^\w\d]+/g,c.prototype.apply=function(a){return o=a.split(this.RE),o&&""===o[o.length-1]&&o.pop(),o},a.Lower=d,d.prototype.apply=function(a){return(""+a).toLowerCase()},a.createNgrams=e,a.addPhraseNgrams=f,a.addTokenNgrams=g,a.getTokenSet=h,a.Pipeline=i,i.prototype.apply=function(a){var b,c,d=0,e=a;for(b=this.steps.length;b>d;d+=1)c=this.steps[d],e=c.apply(e);return e};var l=new i([new d,k,new c]);a.tokenize=j}(window.SuggestionStore=window.SuggestionStore||{});